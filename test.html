<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Compiler Simulator with AI + DSA Parse Tree</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    textarea { width: 100%; height: 150px; }
    ul { list-style-type: none; padding: 0; }
    li { margin: 5px 0; }
    .error { color: red; font-weight: bold; }
    .fix { color: green; font-style: italic; }
    .section { margin-top: 20px; padding: 10px; border: 1px solid black; }
    button { margin-right: 10px; }

    /* DSA Tree Styling */
    #parseTreeOutput {
      display: flex;
      justify-content: center;
      padding: 20px;
    }

    .tree-node {
      text-align: center;
      margin: 0 auto;
      position: relative;
    }

    .node-label {
      display: inline-block;
      background: turquoise;
      color: white;
      padding: 10px;
      border-radius: 50%;
      margin-bottom: 10px;
      font-weight: bold;
    }

    .children {
      display: flex;
      justify-content: space-around;
      margin-top: 10px;
      position: relative;
    }

    .children::before {
      content: '';
      position: absolute;
      top: 0;
      left: 50%;
      width: 0;
      height: 20px;
      border-left: 2px solid black;
    }

    .tree-node .children .tree-node::before {
      content: '';
      position: absolute;
      top: -20px;
      left: 50%;
      width: 2px;
      height: 20px;
      background-color: black;
    }
  </style>
</head>
<body>
  <h2>Compiler Simulator with AI + DSA-Style Parse Tree</h2>
  <textarea id="codeInput" placeholder="Enter C code here..."></textarea><br /><br>
  <button onclick="analyzeCode()">Run Compiler</button>
  <button onclick="explainCode()">Explain Code</button>
  <button onclick="fixCode()">üõ† Auto Fix</button>
  <button onclick="predictOutput()">Predict Output</button>

  <div class="section"><h3>Lexical Analysis (Tokens)</h3><ul id="tokensList"></ul></div>
  <div class="section"><h3>Syntax Errors</h3><ul id="syntaxList"></ul></div>
  <div class="section"><h3>Semantic Errors</h3><ul id="semanticList"></ul></div>
  <div class="section"><h3>Parse Tree (DSA Style)</h3><div id="parseTreeOutput"></div></div>
  <div class="section"><h3>AI Explanation</h3><pre id="explanation"></pre></div>
  <div class="section"><h3>AI Fixed Code</h3><pre id="fixedCode"></pre></div>
  <div class="section"><h3>Predicted Output</h3><pre id="predictedOutput"></pre></div>

  <script>
    async function getAISuggestion(message) {
      try {
        const res = await fetch("http://localhost:3000/suggest", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ message })
        });
        const data = await res.json();
        return data.suggestion || "No suggestion received.";
      } catch {
        return "‚ùå Failed to connect to AI server.";
      }
    }

    class TreeNode {
      constructor(value) {
        this.value = value;
        this.left = null;
        this.right = null;
      }
    }

    function renderTreeDOM(node) {
      if (!node) return null;

      const elem = document.createElement("div");
      elem.classList.add("tree-node");

      const label = document.createElement("div");
      label.classList.add("node-label");
      label.innerText = node.value;

      const container = document.createElement("div");
      container.classList.add("children");

      if (node.left) container.appendChild(renderTreeDOM(node.left));
      if (node.right) container.appendChild(renderTreeDOM(node.right));

      elem.appendChild(label);
      if (node.left || node.right) elem.appendChild(container);

      return elem;
    }

    function generateParseTree(code) {
      const treeContainer = document.getElementById("parseTreeOutput");
      treeContainer.innerHTML = "";

      const lines = code.split('\n').map(line => line.trim()).filter(Boolean);
      const lastLine = lines.reverse().find(line => line.includes('=') && /[+\-*/]/.test(line));

      if (!lastLine) {
        treeContainer.innerText = "‚ùå Only supports simple expressions like: a = b + c;";
        return;
      }

      const match = lastLine.match(/(\w+)\s*=\s*(\w+|\d+)\s*([+\-*/])\s*(\w+|\d+);?/);
      if (!match) {
        treeContainer.innerText = "‚ùå Unable to parse expression.";
        return;
      }

      const [_, lhs, op1, operator, op2] = match;
      const root = new TreeNode("=");
      root.left = new TreeNode(lhs);

      const opNode = new TreeNode(operator);
      opNode.left = new TreeNode(op1);
      opNode.right = new TreeNode(op2);

      root.right = opNode;

      const domTree = renderTreeDOM(root);
      treeContainer.appendChild(domTree);
    }

    function analyzeCode() {
  const code = document.getElementById("codeInput").value;
  let tokens = [], syntaxErrors = [], semanticErrors = [];

  const keywords = ["int", "float", "char", "if", "else", "while", "return"];
  const operators = ["==", "!=", "<=", ">=", "=", "+", "-", "*", "/"];
  const symbols = ["{", "}", "(", ")", ";", ","];

  const declaredVariables = new Set();
  const variableTypes = {};

  const tokenMatches = code.match(/\b(int|float|char|if|else|while|return)\b|"(.*?)"|[a-zA-Z_][a-zA-Z0-9_]*|\d+|==|!=|<=|>=|[=+\-*/{}();,]/g) || [];

  tokenMatches.forEach((token, i) => {
    if (keywords.includes(token)) {
      tokens.push(`Keyword: ${token}`);
      if (i + 1 < tokenMatches.length && /^[a-zA-Z_][a-zA-Z0-9_]*$/.test(tokenMatches[i + 1])) {
        const varName = tokenMatches[i + 1];
        if (declaredVariables.has(varName)) {
          semanticErrors.push(`Redeclaration of variable: ${varName}`);
        } else {
          declaredVariables.add(varName);
          variableTypes[varName] = token;
        }
      }
    } else if (operators.includes(token)) {
      tokens.push(`Operator: ${token}`);
    } else if (symbols.includes(token)) {
      tokens.push(`Symbol: ${token}`);
    } else if (!isNaN(token)) {
      tokens.push(`Number: ${token}`);
    } else if (/^".*"$/.test(token)) {
      tokens.push(`String: ${token}`);
    } else if (/^[a-zA-Z_][a-zA-Z0-9_]*$/.test(token)) {
      tokens.push(`Identifier: ${token}`);

      // üõ†Ô∏è Check undeclared identifier if not immediately after declaration
      const prevToken = tokenMatches[i - 1];
      const isDeclaration = keywords.includes(prevToken);
      if (!declaredVariables.has(token) && !isDeclaration) {
        semanticErrors.push(`Undeclared variable used: ${token}`);
      }
    } else {
      syntaxErrors.push(`Unknown token: ${token}`);
    }
  });

  document.getElementById("tokensList").innerHTML = tokens.map(t => `<li>${t}</li>`).join("\n");

  const lines = code.split("\n");
  lines.forEach((line, index) => {
    if (line.trim() && !line.trim().endsWith(";") && !line.includes("{") && !line.includes("}")) {
      syntaxErrors.push(`Syntax Error at line ${index + 1}: Missing semicolon.`);
    }
  });

  document.getElementById("syntaxList").innerHTML = syntaxErrors.map(e => `<li class="error">${e}</li>`).join("\n");
  document.getElementById("semanticList").innerHTML = semanticErrors.map(e => `<li class="error">${e}</li>`).join("\n");

  generateParseTree(code);
}


    async function explainCode() {
      const code = document.getElementById("codeInput").value;
      const suggestion = await getAISuggestion(`Explain what this C code does:\n${code}`);
      document.getElementById("explanation").innerText = suggestion;
    }

    async function fixCode() {
      const code = document.getElementById("codeInput").value;
      const suggestion = await getAISuggestion(`Fix and rewrite this C code:\n${code}`);
      document.getElementById("fixedCode").innerText = suggestion;
    }

    async function predictOutput() {
      const code = document.getElementById("codeInput").value;
      let input = "";

      if (code.includes("scanf")) {
        input = prompt("Enter input values (for scanf):", "e.g. 5 10");
        if (input === null) input = "";
      }

      const suggestion = await getAISuggestion(`What will be the output of this C code?\nCode:\n${code}\nUser Input:\n${input}`);
      document.getElementById("predictedOutput").innerText = suggestion;
    }
  </script>
</body>
</html>
